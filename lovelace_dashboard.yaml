# Hoymiles S-Miles Health Dashboard
# Copy this into a new dashboard or add to existing one
# Dashboard ‚Üí Add Dashboard ‚Üí Type: YAML

title: Hoymiles S-Miles Monitor
icon: mdi:solar-power
views:
  - title: Overview
    path: overview
    icon: mdi:view-dashboard
    badges: []
    cards:
      # Status Banner
      - type: horizontal-stack
        cards:
          - type: entity
            entity: binary_sensor.hoymiles_smiles_healthy
            name: Health
            icon: mdi:heart-pulse
          - type: entity
            entity: sensor.hoymiles_dtu_status
            name: DTU
            icon: mdi:solar-power
          - type: entity
            entity: sensor.hoymiles_smiles_uptime_formatted
            name: Uptime
            icon: mdi:clock-check

      # Main Status Card
      - type: entities
        title: üè• Application Health
        state_color: true
        entities:
          - entity: binary_sensor.hoymiles_smiles_healthy
            name: Overall Status
            type: attribute
            attribute: last_changed
            format: relative
            secondary_info: last-changed
          - type: divider
          - entity: sensor.hoymiles_smiles_uptime_formatted
            name: Running For
            icon: mdi:timer-outline
          - entity: sensor.hoymiles_dtu_last_query
            name: Last Query Age
            icon: mdi:clock-fast
          - entity: sensor.hoymiles_dtu_query_count
            name: Total Queries
            icon: mdi:counter
          - entity: sensor.hoymiles_dtu_error_count
            name: Query Errors
            icon: mdi:alert-circle-outline

      # Query Age Gauge
      - type: gauge
        entity: sensor.hoymiles_dtu_last_query
        name: Time Since Last Query
        unit: seconds
        min: 0
        max: 600
        severity:
          green: 0
          yellow: 300
          red: 420
        needle: true

      # S-Miles Statistics
      - type: entities
        title: üì° S-Miles Activity
        entities:
          - entity: sensor.hoymiles_smiles_messages_published
            name: Messages Published
            icon: mdi:message-arrow-right
            secondary_info: last-changed
          - entity: sensor.hoymiles_smiles_errors
            name: S-Miles Errors
            icon: mdi:message-alert
          - type: custom:mini-graph-card
            entities:
              - entity: sensor.hoymiles_smiles_messages_published
                name: Message Rate
                show_state: true
            hours_to_show: 24
            line_width: 2
            font_size: 75
            animate: true
            show:
              labels: false
              points: false

      # Database Stats
      - type: entities
        title: üíæ Database
        entities:
          - entity: sensor.hoymiles_smiles_database_size
            name: Size
            icon: mdi:database
          - entity: sensor.hoymiles_smiles_cached_records
            name: Cached Records
            icon: mdi:database-clock

  - title: Metrics
    path: metrics
    icon: mdi:chart-line
    badges: []
    cards:
      # Performance History
      - type: history-graph
        title: Query Performance (24h)
        hours_to_show: 24
        entities:
          - entity: sensor.hoymiles_dtu_last_query
            name: Query Age
          - entity: sensor.hoymiles_dtu_error_count
            name: Errors

      # Message Statistics
      - type: history-graph
        title: S-Miles Messages (24h)
        hours_to_show: 24
        entities:
          - entity: sensor.hoymiles_smiles_messages_published
            name: Published

      # Uptime Statistics
      - type: statistic
        entity: sensor.hoymiles_smiles_uptime
        name: Average Uptime
        stat_type: mean
        period:
          calendar:
            period: week

      # Error Rate Card
      - type: entities
        title: üìä Statistics
        entities:
          - type: custom:multiple-entity-row
            entity: sensor.hoymiles_dtu_query_count
            name: DTU Queries
            secondary_info: last-changed
            entities:
              - entity: sensor.hoymiles_dtu_error_count
                name: Errors
          - type: custom:multiple-entity-row
            entity: sensor.hoymiles_smiles_messages_published
            name: S-Miles Messages
            secondary_info: last-changed
            entities:
              - entity: sensor.hoymiles_smiles_errors
                name: Errors

      # Mini graphs
      - type: horizontal-stack
        cards:
          - type: custom:mini-graph-card
            entities:
              - entity: sensor.hoymiles_dtu_last_query
                name: Query Age
            hours_to_show: 12
            line_width: 2
            font_size: 75
            animate: true
            show:
              name: true
              icon: true
              state: true
              labels: false

          - type: custom:mini-graph-card
            entities:
              - entity: sensor.hoymiles_smiles_database_size
                name: DB Size
            hours_to_show: 168
            line_width: 2
            font_size: 75
            animate: true
            show:
              name: true
              icon: true
              state: true
              labels: false

  - title: Alerts
    path: alerts
    icon: mdi:bell-alert
    badges: []
    cards:
      # Active Issues
      - type: conditional
        conditions:
          - entity: binary_sensor.hoymiles_smiles_healthy
            state: "off"
        card:
          type: markdown
          content: |
            ## ‚ö†Ô∏è Application Unhealthy
            
            The Hoymiles S-Miles application is reporting an unhealthy status.
            
            **Last Query:** {{ states('sensor.hoymiles_dtu_last_query') }}s ago
            **Error Count:** {{ states('sensor.hoymiles_dtu_error_count') }}
            
            Check the application logs for details.
          title: Health Alert

      # Error Summary
      - type: entities
        title: üö® Error Monitoring
        state_color: true
        entities:
          - entity: sensor.hoymiles_dtu_error_count
            name: DTU Query Errors
            icon: mdi:alert-circle
          - entity: sensor.hoymiles_smiles_errors
            name: S-Miles Errors
            icon: mdi:message-alert
          - type: divider
          - type: button
            name: View Logs
            icon: mdi:text-box-search
            tap_action:
              action: url
              url_path: http://192.168.1.31:8090/stats

      # Recent Activity Timeline
      - type: logbook
        entities:
          - binary_sensor.hoymiles_smiles_healthy
          - sensor.hoymiles_dtu_status
        hours_to_show: 24
        title: Recent Status Changes

  - title: Details
    path: details
    icon: mdi:information
    badges: []
    cards:
      # Full Health Status
      - type: markdown
        title: üìã Health Details
        content: |
          ### Application Status
          
          **Health:** {{ states('binary_sensor.hoymiles_smiles_healthy') }}
          **Uptime:** {{ states('sensor.hoymiles_smiles_uptime_formatted') }}
          **Start Time:** {{ state_attr('sensor.hoymiles_smiles_health_status', 'start_time') }}
          
          ### DTU Connection
          
          **Status:** {{ states('sensor.hoymiles_dtu_status') }}
          **Last Query:** {{ states('sensor.hoymiles_dtu_last_query') }}s ago
          **Total Queries:** {{ states('sensor.hoymiles_dtu_query_count') }}
          **Errors:** {{ states('sensor.hoymiles_dtu_error_count') }}
          
          ### S-Miles Stats
          
          **Messages Published:** {{ states('sensor.hoymiles_smiles_messages_published') }}
          **Errors:** {{ states('sensor.hoymiles_smiles_errors') }}
          
          ### Database
          
          **Size:** {{ states('sensor.hoymiles_smiles_database_size') }} MB
          **Cached Records:** {{ states('sensor.hoymiles_smiles_cached_records') }}

      # Raw Data Card
      - type: entities
        title: üîç Raw Sensor Data
        entities:
          - entity: sensor.hoymiles_smiles_health_status
            type: attribute
            attribute: dtus
          - entity: sensor.hoymiles_smiles_health_status
            type: attribute
            attribute: smiles
          - entity: sensor.hoymiles_smiles_health_status
            type: attribute
            attribute: uptime_seconds
          - entity: sensor.hoymiles_smiles_health_status
            type: attribute
            attribute: start_time

      # API Endpoints
      - type: markdown
        title: üîó API Endpoints
        content: |
          Quick links to health endpoints:
          
          - [Health Status](http://192.168.1.31:8090/health)
          - [Ready Check](http://192.168.1.31:8090/ready)
          - [Metrics](http://192.168.1.31:8090/metrics)
          - [Statistics](http://192.168.1.31:8090/stats)
          
          **Note:** Update IP address if needed

      # System Information
      - type: entities
        title: ‚ÑπÔ∏è System Info
        entities:
          - type: attribute
            entity: sensor.hoymiles_smiles_health_status
            attribute: start_time
            name: Started At
            icon: mdi:clock-start
          - entity: sensor.hoymiles_smiles_uptime
            name: Uptime (seconds)
            icon: mdi:timer
          - entity: sensor.hoymiles_smiles_database_size
            name: Database Size
            icon: mdi:database

